---
title: "Representation Version Count Model Analysis"
format: html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(tidyverse)
library(ggthemes)
library(patchwork)
library(here)
```

```{r run-model}
# Run the Python model to generate data
system("python representation_version_count.py", wait = TRUE)
```

```{r load-data}
# Load the representation version count data
rep_count_df <- read_csv(here("models/representation_version_count.csv"))

# Separate belief and info percentage data
belief_data <- rep_count_df %>%
  select(Trial, contains("belief")) %>%
  pivot_longer(cols = contains("belief"), 
               names_to = "agent", 
               values_to = "belief") %>%
  mutate(agent = str_remove(agent, "_belief"),
         measure = "Belief")

info_data <- rep_count_df %>%
  select(Trial, contains("info_pct")) %>%
  pivot_longer(cols = contains("info_pct"), 
               names_to = "agent", 
               values_to = "info_percentage") %>%
  mutate(agent = str_remove(agent, "_info_pct"),
         measure = "Information Percentage")

# Combine for dual-axis plotting
combined_data <- belief_data %>%
  left_join(info_data %>% select(Trial, agent, info_percentage), 
            by = c("Trial", "agent"))
```

```{r belief-evolution, fig.width=10, fig.height=6}
# Plot belief evolution over trials
belief_plot <- belief_data %>%
  ggplot(aes(x = Trial, y = belief, color = agent)) +
  geom_point(size = 2) +
  geom_line(linewidth = 1) +
  scale_color_brewer(palette = 'Set2') +
  labs(title = 'Representation Count Model: Belief Evolution', 
       y = 'Belief (Probability)', 
       x = 'Trial', 
       color = 'Agent') +
  theme_few() +
  theme(legend.position = 'bottom') +
  ylim(0, 1)

belief_plot
```

```{r info-evolution, fig.width=10, fig.height=6}
# Plot information percentage evolution over trials
info_plot <- info_data %>%
  ggplot(aes(x = Trial, y = info_percentage, color = agent)) +
  geom_point(size = 2) +
  geom_line(linewidth = 1) +
  scale_color_brewer(palette = 'Set2') +
  labs(title = 'Representation Count Model: Information Percentage Evolution', 
       y = 'Information Percentage', 
       x = 'Trial', 
       color = 'Agent') +
  theme_few() +
  theme(legend.position = 'bottom')

info_plot
```

```{r dual-plot, fig.width=12, fig.height=8}
# Create dual-axis visualization
p1 <- belief_data %>%
  ggplot(aes(x = Trial, y = belief, color = agent)) +
  geom_point(alpha = 0.7) +
  geom_line(linewidth = 1) +
  scale_color_brewer(palette = 'Set2') +
  labs(title = 'Beliefs', 
       y = 'Belief (Probability)', 
       x = 'Trial') +
  theme_few() +
  theme(legend.position = 'none') +
  ylim(0, 1)

p2 <- info_data %>%
  ggplot(aes(x = Trial, y = info_percentage, color = agent)) +
  geom_point(alpha = 0.7) +
  geom_line(linewidth = 1) +
  scale_color_brewer(palette = 'Set2') +
  labs(title = 'Information Percentage', 
       y = 'Info Percentage', 
       x = 'Trial',
       color = 'Agent') +
  theme_few() +
  theme(legend.position = 'bottom')

# Combine plots
combined_plot <- p1 / p2
combined_plot + plot_annotation(title = "Representation Count Model: Dual Tracking")
```

```{r convergence-analysis}
# Analyze convergence patterns
final_beliefs <- belief_data %>%
  filter(Trial == max(Trial)) %>%
  pull(belief)

final_info <- info_data %>%
  filter(Trial == max(Trial)) %>%
  pull(info_percentage)

cat("Final Belief Values:\n")
cat(paste("Agent", 1:4, ":", round(final_beliefs, 3), "\n"))
cat("\nFinal Information Percentages:\n")
cat(paste("Agent", 1:4, ":", round(final_info, 3), "\n"))

# Calculate belief convergence (variance)
belief_variance_by_trial <- belief_data %>%
  group_by(Trial) %>%
  summarise(belief_variance = var(belief), .groups = 'drop')

cat("\nBelief Variance Over Time:\n")
print(belief_variance_by_trial)
```

```{r trajectory-plot, fig.width=10, fig.height=6}
# Plot belief-info trajectories
combined_data %>%
  ggplot(aes(x = info_percentage, y = belief, color = agent)) +
  geom_path(arrow = arrow(length = unit(0.2, "cm")), linewidth = 1) +
  geom_point(size = 2) +
  scale_color_brewer(palette = 'Set2') +
  labs(title = 'Representation Count: Belief vs Information Trajectory', 
       x = 'Information Percentage', 
       y = 'Belief (Probability)',
       color = 'Agent') +
  theme_few() +
  theme(legend.position = 'bottom')
```

```{r information-growth-analysis}
# Analyze how information grows differently in count model
info_growth <- info_data %>%
  arrange(agent, Trial) %>%
  group_by(agent) %>%
  mutate(info_change = info_percentage - lag(info_percentage, default = 0)) %>%
  ungroup()

info_growth %>%
  filter(Trial > 0) %>%
  ggplot(aes(x = Trial, y = info_change, color = agent)) +
  geom_point(size = 2) +
  geom_line(linewidth = 1) +
  scale_color_brewer(palette = 'Set2') +
  labs(title = 'Information Growth Rate by Trial', 
       y = 'Change in Info Percentage', 
       x = 'Trial',
       color = 'Agent') +
  theme_few() +
  theme(legend.position = 'bottom')
```

